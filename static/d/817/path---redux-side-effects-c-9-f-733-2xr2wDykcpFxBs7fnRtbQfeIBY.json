{"data":{"site":{"siteMetadata":{"title":"TIL"}},"markdownRemark":{"id":"62480162-a736-5435-823e-8cd5dcd78d97","excerpt":"Redux  is the preferred state management pattern for React apps today. Being a very \"functional\" library, it doesn't like side effects much…","htmlAst":{"type":"element","tagName":"div","properties":{},"children":[{"type":"element","tagName":"h3","properties":{},"children":[]},{"type":"comment","value":" {.-wider-literate-style} "},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"a","properties":{"href":"http://redux.js.org/"},"children":[{"type":"text","value":"Redux"}]},{"type":"text","value":" is the preferred state management pattern for React apps today. Being a very \"functional\" library, it doesn't like side effects much. This means doing asynchronous actions in a Redux reducer is not just a bad idea, it simply won't work."}]},{"type":"element","tagName":"pre","properties":{},"children":[{"type":"element","tagName":"code","properties":{"className":["language-js"]},"children":[{"type":"text","value":"/* ✗ Warning: This won't work! */\n\nfunction reducer (state, action) {\n  switch (action.type) {\n    case 'profile:load':\n      fetch('/my_profile')\n        .then(res => res.json())\n        .then(res => {\n          dispatch({\n            type: 'profile:set',\n            payload: res.body\n          })\n          // ✗ Error: dispatch is not defined\n        })\n\n        ...\n"}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"You can't modify state here in an async callback. In fact, you can't even "},{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":"dispatch()"}]},{"type":"text","value":" in a reducer! This won't work and is a bad idea; you break the purity of the store reducer."}]},{"type":"element","tagName":"h2","properties":{},"children":[{"type":"text","value":"Using Middleware"}]},{"type":"element","tagName":"h3","properties":{},"children":[{"type":"text","value":"Middleware for side effects"}]},{"type":"comment","value":" {.-wider-literate-style} "},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Fortunately, Redux has built-in provisions for managing side effects: "},{"type":"element","tagName":"a","properties":{"href":"http://redux.js.org/docs/advanced/Middleware.html"},"children":[{"type":"text","value":"Middleware"}]},{"type":"text","value":"! You can write your own middleware with business logic. You don't need to use 3rd-party packages other than Redux itself."}]},{"type":"element","tagName":"pre","properties":{},"children":[{"type":"element","tagName":"code","properties":{"className":["language-js"]},"children":[{"type":"text","value":"// Redux middleware\nfunction ProfileLoader () {\n  return store => dispatch => action {\n    // First pass them through to the reducers.\n    dispatch(action)\n\n    switch (action.type) {\n      case 'profile:load!':\n        fetch('/my_profile')\n          .then(res => res.json())\n          .then(res => dispatch({ type: 'profile:set', payload: res.body }))\n          .catch(err => dispatch({ type: 'profile:error', payload: err }))\n    }\n  }\n}\n\n// Use the middleware in your store\nstore = createStore(reducers, {}, applyMiddleware(\n  ProfileLoader()\n)\n"}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Redux middleware is simply a decorator for "},{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":"dispatch()"}]},{"type":"text","value":". Here's an example where we extend "},{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":"dispatch()"}]},{"type":"text","value":" to perform certain side effects (an AJAX call, in this case) when certain actions come in."}]},{"type":"element","tagName":"h2","properties":{},"children":[{"type":"text","value":"Other solutions"}]},{"type":"element","tagName":"h3","properties":{},"children":[{"type":"text","value":"Using redux-thunk"}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Perhaps the most well-known solution to this is "},{"type":"element","tagName":"a","properties":{"href":"https://www.npmjs.com/package/redux-thunk"},"children":[{"type":"text","value":"redux-thunk"}]},{"type":"text","value":", which allows you to dispatch functions (\"thunks\")."}]},{"type":"element","tagName":"pre","properties":{},"children":[{"type":"element","tagName":"code","properties":{"className":["language-js"]},"children":[{"type":"text","value":"// Using a function as an action via redux-thunk\nstore.dispatch(dispatch => {\n  fetch('/my_profile')\n    .then(res => res.json())\n    .then(res => dispatch({ type: 'profile:set', payload: res.body }))\n    .catch(err => dispatch({ type: 'profile:error', payload: err }))\n})\n"}]}]},{"type":"comment","value":" {.-wide} "},{"type":"element","tagName":"h3","properties":{},"children":[{"type":"text","value":"Why not use redux-thunk?"}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"I personally advise against this approach for a number of reasons:"}]},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"It moves logic to your action creators, which were supposed to be very simple pieces of code."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"It makes actions complicated, when they can just be simple JSON instructions (eg, "},{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":"{ type: 'profile:load' }"}]},{"type":"text","value":")."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"It can't interact with other side effects. For instance, you can't make a side effect to send "},{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":"profile:error"}]},{"type":"text","value":"s to an error tracking service. Middleware can do this."}]},{"type":"text","value":"\n"}]},{"type":"element","tagName":"h2","properties":{},"children":[{"type":"text","value":"Naming convention"}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"You may have noticed I named my action "},{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":"profile:load!"}]},{"type":"text","value":". This is my preferred convention of choice, where action names are simply strings, and \"side effect\" actions are suffixed with an exclamation mark, just as it would in Ruby or Elixir."}]},{"type":"element","tagName":"h2","properties":{},"children":[{"type":"text","value":"Other examples"}]},{"type":"element","tagName":"h3","properties":{},"children":[{"type":"text","value":"Error tracker"}]},{"type":"comment","value":" {.-wider-literate-style} "},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"How about a middleware that tracks errors as they come in?"}]},{"type":"element","tagName":"pre","properties":{},"children":[{"type":"element","tagName":"code","properties":{"className":["language-js"]},"children":[{"type":"text","value":"function ErrorTracker () {\n  return store => dispatch => action {\n    dispatch(action)\n\n    switch (action.type) {\n      case 'profile:error':\n      case 'account:error':\n      case 'other:error':\n        Rollbar.track(action.payload)\n    }\n  }\n}\n"}]}]},{"type":"element","tagName":"h3","properties":{},"children":[{"type":"text","value":"Ticker"}]},{"type":"comment","value":" {.-literate-style} "},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Or a middleware that sends "},{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":"tick"}]},{"type":"text","value":" events every second? Great for timers or for RPG's."}]},{"type":"element","tagName":"pre","properties":{},"children":[{"type":"element","tagName":"code","properties":{"className":["language-js"]},"children":[{"type":"text","value":"function Ticker (options) {\n  let timer\n\n  return store => dispatch => action {\n    dispatch(action)\n\n    switch (action.type) {\n      case 'ticker:start!':\n        timer = setInterval(() => {\n          store.dispatch({ type: 'ticker:tick', now: new Date() })\n        }, options.interval)\n        break\n\n      case 'ticker:stop!':\n        if (timer) clearInterval(timer)\n        timer = null\n        break\n    }\n  }\n}\n"}]}]},{"type":"element","tagName":"h3","properties":{},"children":[{"type":"text","value":"Combining them"}]},{"type":"comment","value":" {.-literate-style} "},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"And to put them all together:"}]},{"type":"element","tagName":"pre","properties":{},"children":[{"type":"element","tagName":"code","properties":{"className":["language-js"]},"children":[{"type":"text","value":"store = createStore(reducers, {}, applyMiddleware(\n  ProfileLoader(),\n  ErrorTracker(),\n  Ticker({ interval: 1000 })\n)\n"}]}]},{"type":"element","tagName":"h2","properties":{},"children":[{"type":"text","value":"See also"}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Check out "},{"type":"element","tagName":"a","properties":{"href":"http://devguides.io/redux"},"children":[{"type":"text","value":"Redux on devguides.io"}]},{"type":"text","value":"! Devguides.io is my new pet project where I make pocket-sized explainers for web development concepts."}]}]},"fields":{"slug":"/redux-side-effects/"},"frontmatter":{"title":"Managing side effects in Redux","date":"March 14, 2017","description":"Learn to manage impure side effects in a Redux store with middleware.","attachments":null}}},"pageContext":{"node_id":"62480162-a736-5435-823e-8cd5dcd78d97","nodeType":"post","title":"Managing side effects in Redux","slug":"/redux-side-effects/","previous":{"id":"c200b7e1-be30-508c-b928-29098f297bdf","fields":{"slug":"/rails-mailer-race-conditions/"},"frontmatter":{"title":"Rails mailer conventions are silly"}},"next":{"id":"b046190e-82e3-5a09-8153-9b2269c2fcd4","fields":{"slug":"/life-in-side-quests/"},"frontmatter":{"title":"Your life is a series of side quests"}}}}