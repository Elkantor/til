<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/tilnext/component---src-templates-blog-post-js.9973955363fca1c00852.css">@import url(https://typeof.net/Iosevka/iosevka/webfont.css);@import url(https://fonts.googleapis.com/css?family=Alegreya:400i);@import url(https://fonts.googleapis.com/css?family=IBM+Plex+Sans);@import url(https://fonts.googleapis.com/css?family=Chivo:400,700);.next-block{font-weight:400;font-family:Iosevka Web,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;font-style:normal;letter-spacing:0;clear:both;margin:0;color:#303030;font-style:italic;padding-top:1.5em;font-size:.9em}.next-block>strong{font-weight:700;text-transform:uppercase;padding:.2em;background:rgba(164,234,215,.5);color:#3fb07e;font-style:normal}.next-block:after{content:"";display:inline-block;vertical-align:middle;width:128px;height:2px;background:#a4ead7;margin:0 16px}.h2-section{padding-left:16px;padding-right:16px}@media (min-width:900px){.h2-section{padding-left:80px}}@media (min-width:1200px){.h2-section{padding-left:calc(55vw - 528px);padding-right:calc(45vw - 432px)}}.h2-section:after{content:"";display:block;position:absolute;width:1px;background:rgba(119,136,153,.2)}@media (min-width:900px){.h2-section:after{display:block;left:64px;top:48px;bottom:16px}}.h2-section{padding-top:64px;padding-bottom:96px;position:relative;margin:0 32px;-webkit-transform-origin:32px 50%;transform-origin:32px 50%;border:1px solid transparent}.h2-section+.h2-section{margin-top:32px}.h2-section>h2{font-weight:700;font-family:Chivo,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;font-size:2.0736em;color:#080808;margin-bottom:32px;line-height:1.4;text-shadow:2px 0 0 rgba(164,234,215,.4);max-width:60%}.h2-section{transition:background-color .25s linear,box-shadow .25s linear,-webkit-transform .25s ease-in,-webkit-filter .25s linear;transition:background-color .25s linear,box-shadow .25s linear,transform .25s ease-in,filter .25s linear;transition:background-color .25s linear,box-shadow .25s linear,transform .25s ease-in,filter .25s linear,-webkit-transform .25s ease-in,-webkit-filter .25s linear}.h2-section>.body,.h2-section>h2{transition:opacity .25s linear,color .25s linear}.h2-section.-inactive{-webkit-transform:scale(.99);transform:scale(.99);background:#fff;box-shadow:0 1px 2px rgba(17,34,68,.06667);z-index:1}.h2-section.-inactive:after{background-color:rgba(119,136,153,.13333)}.h2-section.-inactive>h2{color:#a4ead7;text-shadow:none}.h2-section.-inactive>.body{opacity:.2}.h2-section.-active{border-radius:2px;box-shadow:0 2px 3px rgba(51,68,85,.13333),0 16px 24px rgba(51,68,85,.13333);background-color:#fff;z-index:5;border-color:rgba(119,136,153,.2)}@media (min-width:768.1px){[id] .h3-section{max-width:60%}}[id] .h3-section>h3{font-weight:400;font-family:Iosevka Web,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;font-style:normal;letter-spacing:.1em;margin-top:3.5em;text-transform:uppercase;font-size:.95em;color:#3fb07e;margin-bottom:.3em}[id] .h3-section>h3:empty{display:none}[id] .h3-section>.body,[id] .h3-section>.body>:first-child{margin-top:0}.h3-section.-literate-style,.h3-section.-reverse-literate-style{max-width:100vw}.h3-section.-literate-style>.body:after,.h3-section.-literate-style>:after,.h3-section.-reverse-literate-style>.body:after,.h3-section.-reverse-literate-style>:after{content:"";display:table;clear:both;zoom:1}.h3-section.-literate-style>.body>p,.h3-section.-reverse-literate-style>.body>p{width:50%;float:left;padding-right:32px;margin-top:0}.h3-section.-literate-style>.body>blockquote,.h3-section.-literate-style>.body>pre,.h3-section.-reverse-literate-style>.body>blockquote,.h3-section.-reverse-literate-style>.body>pre{width:50%;float:right;margin-top:0}.h3-section.-reverse-literate-style>.body>p{width:50%;float:right;padding-left:32px}.h3-section.-reverse-literate-style>.body>blockquote,.h3-section.-reverse-literate-style>.body>pre{width:50%;float:left}.blog-post-content{background:#f3f5f8;box-shadow:inset 128px 0 0 #fff,inset 0 32px 0 #fff}.blog-post-content,.MarkdownBody{font-family:IBM Plex Sans,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;font-size:16.5px;font-weight:500;line-height:1.55;color:#303030}.blog-post-content a,.blog-post-content a:visited,.MarkdownBody a,.MarkdownBody a:visited{font-family:Alegreya,sans-serif;font-size:1.1em;line-height:.2em;font-style:italic;color:#303030;text-decoration:none;white-space:nowrap}.blog-post-content a:after,.MarkdownBody a:after{content:"#";display:inline-block;font-size:.8em;font-weight:700;width:14px;height:14px;line-height:14px;text-align:center;margin:0 4px;border-radius:50%;background:#a4ead7;color:#fff}.blog-post-content em,.MarkdownBody em{font-family:Alegreya,sans-serif;font-size:1.1em;line-height:.2em;font-style:italic}.blog-post-content strong,.MarkdownBody strong{font-weight:700}.blog-post-content h3,.blog-post-content ol,.blog-post-content p,.blog-post-content pre,.blog-post-content ul,.MarkdownBody h3,.MarkdownBody ol,.MarkdownBody p,.MarkdownBody pre,.MarkdownBody ul{margin-top:1.5em;margin-bottom:1.5em}.blog-post-content h3+p,.MarkdownBody h3+p{margin-top:-1.5em}.blog-post-content pre,.MarkdownBody pre{background:#fff;box-shadow:inset 0 0 0 2px #a4ead7;margin:2.5em 0;line-height:1.4;padding:24px;border-radius:4px;font-size:.86em}.blog-post-content code,.MarkdownBody code{font-family:Iosevka Web,monospace;padding:.2em;font-size:.9em;background:#fcfcfc;background:rgba(164,234,215,.5)}.blog-post-content pre code,.MarkdownBody pre code{background:transparent;padding:0;font-size:1em}.blog-post-title{padding-left:16px;padding-right:16px}@media (min-width:900px){.blog-post-title{padding-left:80px}}@media (min-width:1200px){.blog-post-title{padding-left:calc(55vw - 528px);padding-right:calc(45vw - 432px)}}.blog-post-title:after{content:"";display:block;position:absolute;width:1px;background:rgba(119,136,153,.2)}@media (min-width:900px){.blog-post-title:after{display:block;left:64px;top:48px;bottom:16px}}.blog-post-title{background:#fff;padding-bottom:128px;border-radius:2px;box-shadow:0 2px 3px rgba(51,68,85,.13333),0 16px 24px rgba(51,68,85,.13333);position:relative;margin:256px 32px 32px;border:1px solid #eee;z-index:5}.blog-post-title>h1{font-weight:200;font-family:Iosevka Web,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;font-size:4.29982em;text-shadow:2px 2px #fff,4px 4px 0 rgba(164,234,215,.8);padding:0;line-height:1.2;margin:-.6em 0 0}@media (min-width:768.1px){.blog-post-title>h1{max-width:50%}}.blog-post-title>hr{border:0;content:"";display:block;height:2px;background:linear-gradient(90deg,#8fffcd,#a4ead7 20%,transparent 0);margin:16px 0}@media (min-width:768.1px){.blog-post-title>hr{margin:48px 0}}.blog-post-title>.byline{font-family:Chivo,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;font-weight:400;margin-top:1em;color:#3fb07e;font-size:.9em}.blog-post-title>.byline:before{content:"";display:inline-block;background:#3fb07e;width:32px;vertical-align:middle;height:2px;margin-right:16px;margin-left:-16px}@media (min-width:768.1px){.blog-post-title>.byline{margin:2.5em 0}}.blog-post-title>h1>.blinker{display:inline-block;vertical-align:middle;width:.6em;height:1em;background:repeating-linear-gradient(45deg,#fff,#fff 4px,transparent 0,transparent 6px),linear-gradient(30deg,#a4ead7,#8fffcd);margin-left:-.2em;margin-top:-.1em;-webkit-animation:cursor-blink 1.2s ease-in infinite;animation:cursor-blink 1.2s ease-in infinite}@-webkit-keyframes cursor-blink{0%{opacity:1}60%{opacity:1}to{opacity:0}}@keyframes cursor-blink{0%{opacity:1}60%{opacity:1}to{opacity:0}}.main-heading>.left{position:fixed;top:32px;left:32px}.main-heading>.left>.brandlink{display:block;width:48px;height:6px;border:2px solid #a4ead7;border-radius:4px}.main-heading>.right{max-width:300px;line-height:1.7;display:block;position:fixed;top:32px;right:64px;color:#708090;font-size:.86em;text-align:right;opacity:.5}.main-heading>.right>a{color:#333;text-decoration:none;font-weight:700}.main-heading>.right>.line{display:inline-block;vertical-align:middle;width:48px;height:2px;background:rgba(119,136,153,.26667);margin-bottom:8px}.post-title-snip-c>div{display:inline-block}.post-title-snip{font-family:Iosevka Web,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;font-style:normal;letter-spacing:0;font-weight:400}.post-title-snip.-small{white-space:nowrap;text-transform:uppercase}.blog-nav{position:fixed;left:0;top:0;bottom:0;z-index:8;pointer-events:none;display:none}@media (min-width:900px){.blog-nav{display:block}}.blog-nav>.area{-webkit-transform:rotate(-90deg);transform:rotate(-90deg);-webkit-transform-origin:0 100%;transform-origin:0 100%;height:64px;width:100vh;position:absolute;bottom:0;left:64px;padding:64px 48px 0}.blog-nav>.area>.bar{padding-bottom:16px;font-size:.83333em;font-family:chivo,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;text-align:left;color:rgba(119,136,153,.53333)}.blog-nav>.area>.bar>strong{color:#111}.blog-nav>.area>.bar>strong:after{content:"";display:inline-block;vertical-align:middle;margin:0 24px;width:32px;height:3px;border-radius:2px;background:#a4ead7;position:relative;top:-1px}</style><style data-href="/tilnext/0.67203e8a3f92c8c6c9cb.css">/*! sanitize.css v7.0.3 | CC0 License | github.com/csstools/sanitize.css */*,:after,:before{background-repeat:no-repeat;box-sizing:border-box}:after,:before{text-decoration:inherit;vertical-align:inherit}html{cursor:default;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol,Noto Color Emoji;line-height:1.15;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;word-break:break-word}body{margin:0}h1{font-size:2em;margin:.67em 0}hr{height:0;overflow:visible}main{display:block}nav ol,nav ul{list-style:none}pre{font-family:Menlo,Consolas,Roboto Mono,Ubuntu Monospace,Noto Mono,Oxygen Mono,Liberation Mono,monospace;font-size:1em}a{background-color:transparent}abbr[title]{text-decoration:underline;-webkit-text-decoration:underline dotted;text-decoration:underline dotted}b,strong{font-weight:bolder}code,kbd,samp{font-family:Menlo,Consolas,Roboto Mono,Ubuntu Monospace,Noto Mono,Oxygen Mono,Liberation Mono,monospace;font-size:1em}small{font-size:80%}::-moz-selection{background-color:#b3d4fc;color:#000;text-shadow:none}::selection{background-color:#b3d4fc;color:#000;text-shadow:none}audio,canvas,iframe,img,svg,video{vertical-align:middle}audio,video{display:inline-block}audio:not([controls]){display:none;height:0}img{border-style:none}svg:not([fill]){fill:currentColor}svg:not(:root){overflow:hidden}table{border-collapse:collapse}button,input,select,textarea{font-family:inherit;font-size:inherit;line-height:inherit}button,input,select{margin:0}button{overflow:visible;text-transform:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}fieldset{padding:.35em .75em .625em}input{overflow:visible}legend{color:inherit;display:table;max-width:100%;white-space:normal}progress{display:inline-block;vertical-align:baseline}select{text-transform:none}textarea{margin:0;overflow:auto;resize:vertical}[type=checkbox],[type=radio]{padding:0}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}::-webkit-inner-spin-button,::-webkit-outer-spin-button{height:auto}::-webkit-input-placeholder{color:inherit;opacity:.54}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}::-moz-focus-inner{border-style:none;padding:0}:-moz-focusring{outline:1px dotted ButtonText}details,dialog{display:block}dialog{background-color:#fff;border:solid;color:#000;height:-moz-fit-content;height:-webkit-fit-content;height:fit-content;left:0;margin:auto;padding:1em;position:absolute;right:0;width:-moz-fit-content;width:-webkit-fit-content;width:fit-content}dialog:not([open]){display:none}summary{display:list-item}canvas{display:inline-block}template{display:none}[tabindex],a,area,button,input,label,select,summary,textarea{touch-action:manipulation}[hidden]{display:none}[aria-busy=true]{cursor:progress}[aria-controls]{cursor:pointer}[aria-disabled=true],[disabled]{cursor:not-allowed}[aria-hidden=false][hidden]:not(:focus){clip:rect(0,0,0,0);display:inherit;position:absolute}</style><meta name="generator" content="Gatsby 2.0.38"/><title data-react-helmet="true">Rails mailer conventions are silly | TIL</title><meta data-react-helmet="true" name="keywords" content="sample, something"/><meta data-react-helmet="true" name="description" content="Typical Rails convention will tell you to send email like using the ActiveMailer API using  #deliver_later . This is not a very good idea…"/><link as="script" rel="preload" href="/tilnext/component---src-templates-blog-post-js-9f7b11a0ce57af179380.js"/><link as="script" rel="preload" href="/tilnext/app-56ed2dcbc9dd07530401.js"/><link as="script" rel="preload" href="/tilnext/8-40e807a7dac2a98b548e.js"/><link as="script" rel="preload" href="/tilnext/1-8f92e2ff719e7df31745.js"/><link as="script" rel="preload" href="/tilnext/0-8344ccfb433a1f841116.js"/><link as="script" rel="preload" href="/tilnext/webpack-runtime-1e54438c308aeeba13e5.js"/><link rel="preload" href="/tilnext/static/d/947/path---rails-mailer-race-conditions-cd-0-64f-c053ovoqJy2fVMk5sOWMKn1qiwU.json" as="fetch" crossOrigin="use-credentials"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" role="group"><div><div class="main-heading"><div class="left"><a class="brandlink" href="/tilnext/"></a></div><div class="right"><span class="line"></span><br/><span class="post-title-snip-c -small"><div style="opacity:0" easing=""><strong class="post-title-snip -small">Rails mailer conventions are silly</strong></div></span></div></div><div><div class="blog-nav"><div class="area"><div class="bar"><strong>TIL</strong><span>Rails mailer conventions are silly</span></div></div></div><div class="blog-post-content"><div class="blog-post-title"><h1>Rails mailer conventions are silly<!-- --> <span class="blinker"></span></h1><p class="byline">Written by Rico Sta. Cruz / <!-- -->June 06, 2017</p><div class="MarkdownBody"><div class="body h3-section-list"><section class="h3-section"><div class="body"><p>Typical Rails convention will tell you to send email like using the ActiveMailer API using <code>#deliver_later</code>. This is not a very good idea, and let me tell you why.</p>
<pre><code class="language-ruby">NotificationMailer.notification(@user, @post).deliver_later
</code></pre>
</div></section><section class="h3-section"><h3>Sample implementation</h3><div class="body">
<p>This kind of mailer would typically be implemented like so:</p>
<pre><code class="language-ruby">class NotificationMailer &lt; ApplicationMailer
  def notification(user, post)
    @user = user
    @post = post

    mail to: @user.email,
         subject: &quot;You&#x27;ve got a notification&quot;
  end
end
</code></pre>
<div><blockquote class="next-block"><strong>Next:</strong> <!-- -->Let&#x27;s look at how this can cause problems.</blockquote></div>
</div></section></div></div></div><section class="h2-section -inactive"><h2>Race condition!</h2><div class="body h3-section-list"><section class="h3-section"><div class="body">
<p>If you follow Rails best practices, you&#x27;d be using <code>#deliver_later</code> to send email in the background. This is great for performance, but that means you have to start thinking asynchronously. The code above is written in a very synchronous style and will fail in certain conditions. Consider this scenario:</p>
<ul>
<li>A notification is triggered for user Joe, who is <code>joe@example.com</code>, by creating a new <code>Post</code>.</li>
<li>A background job is created.</li>
<li>Before an email could be sent, the <code>Post</code> is deleted.</li>
<li>The mailer now fails because <code>@post</code> is nil.</li>
</ul>
<div><blockquote class="next-block"><strong>Next:</strong> <!-- -->So how can we fix this?</blockquote></div>
</div></section></div></section><section class="h2-section -inactive"><h2>Think asynchronously</h2><div class="body h3-section-list"><section class="h3-section"><div class="body">
<p>Instead of passing Rails models or record ID&#x27;s, pass a fully-loaded <em>plain hash</em> of everything the mailer needs to send the email. Consider something like this instead:</p>
<pre><code class="language-ruby">NotificationMailer.notification(
  user: {
    email: @user.email
  },
  post: {
    id: @post.id,
    title: @post.title,
    url: post_url(@post)
  }
).deliver_later
</code></pre>
<p>The mailer will now not need to hit the database to fetch any data, eliminating any race conditions. Even if the post is modified or deleted later on, the email will still send just fine.</p></div></section></div></section></div></div><a rel="prev" href="/tilnext/a-better-hello-world/">← <!-- -->A Better Hello World Program</a></div></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.page={"componentChunkName":"component---src-templates-blog-post-js","jsonName":"rails-mailer-race-conditions-cd0","path":"/rails-mailer-race-conditions/"};window.dataPath="947/path---rails-mailer-race-conditions-cd-0-64f-c053ovoqJy2fVMk5sOWMKn1qiwU";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"app":["/app-56ed2dcbc9dd07530401.js"],"component---src-templates-blog-post-js":["/component---src-templates-blog-post-js.9973955363fca1c00852.css","/component---src-templates-blog-post-js-9f7b11a0ce57af179380.js"],"component---src-pages-404-js":["/component---src-pages-404-js.cfd6fa8cb53e5e43daf2.css","/component---src-pages-404-js-02815836d806cb982e3b.js"],"component---src-pages-index-js":["/component---src-pages-index-js.1e4c03736e08d2bfdc74.css","/component---src-pages-index-js-d57c9995a36404d94cc0.js"],"component---src-pages-page-2-js":["/component---src-pages-page-2-js.cfd6fa8cb53e5e43daf2.css","/component---src-pages-page-2-js-3f79bdc12201fecf8691.js"]};/*]]>*/</script><script src="/tilnext/webpack-runtime-1e54438c308aeeba13e5.js" async=""></script><script src="/tilnext/0-8344ccfb433a1f841116.js" async=""></script><script src="/tilnext/1-8f92e2ff719e7df31745.js" async=""></script><script src="/tilnext/8-40e807a7dac2a98b548e.js" async=""></script><script src="/tilnext/app-56ed2dcbc9dd07530401.js" async=""></script><script src="/tilnext/component---src-templates-blog-post-js-9f7b11a0ce57af179380.js" async=""></script></body></html>